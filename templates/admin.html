<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
        // Funktion zur Tabellensortierung – (bereits vorhanden)
        function sortTable(n) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById("adminTable");
            switching = true;
            dir = "asc";
            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    if (n === 0) { // Numerische Sortierung für ID
                        if (dir === "asc") {
                            if (parseInt(x.innerText) > parseInt(y.innerText)) {
                                shouldSwitch = true;
                                break;
                            }
                        } else {
                            if (parseInt(x.innerText) < parseInt(y.innerText)) {
                                shouldSwitch = true;
                                break;
                            }
                        }
                    } else {
                        if (dir === "asc") {
                            if (x.innerText.toLowerCase() > y.innerText.toLowerCase()) {
                                shouldSwitch = true;
                                break;
                            }
                        } else {
                            if (x.innerText.toLowerCase() < y.innerText.toLowerCase()) {
                                shouldSwitch = true;
                                break;
                            }
                        }
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i+1], rows[i]);
                    switching = true;
                    switchcount++;
                } else {
                    if (switchcount === 0 && dir === "asc") {
                        dir = "desc";
                        switching = true;
                    }
                }
            }
        }

        // Funktion zum Löschen eines Geräteeintrags
        async function deleteDevice(deviceId) {
            if (!confirm("Möchten Sie diesen Eintrag wirklich löschen?")) return;
            const response = await fetch("/admin/delete_device/" + deviceId, {
                method: "POST"
            });
            const result = await response.json();
            alert(result.message);
            location.reload();  // Seite neu laden, damit der Eintrag nicht mehr angezeigt wird.
        }

        async function addDevice() {
            const inventoryNumber = document.getElementById("new_inventory_number").value.trim();
            if (!inventoryNumber) {
              alert("Bitte geben Sie eine Inventarnummer ein.");
              return;
            }
            
            try {
              // Debug: Zeige in der Konsole an, dass der Request gestartet wird
              console.log("Starte Anfrage zum Hinzufügen des Geräts:", inventoryNumber);
              
              const response = await fetch('/admin/add_device', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ inventory_number: inventoryNumber })
              });
              
              if (!response.ok) {
                // Wenn der Response nicht ok ist, gebe den Fehler aus
                const errorData = await response.json();
                console.error("Fehler beim Hinzufügen:", errorData);
                alert("Fehler: " + errorData.error);
                return;
              }
              
              const result = await response.json();
              console.log("Erfolg:", result);
              alert(result.message);
              location.reload(); // Seite aktualisieren, damit der Eintrag sofort sichtbar ist.
              
            } catch (error) {
              console.error("Request-Fehler:", error);
              alert("Fehler beim Hinzufügen: " + error);
            }
          }
        

        // Funktion zum Löschen eines Nutzers (optional, falls über Ajax genutzt)
        async function deleteUser(userId) {
            if (!confirm("Möchten Sie diesen Benutzer wirklich löschen?")) return;
            const response = await fetch("/admin/delete_user/" + userId, {
                method: "POST"
            });
            const result = await response.json();
            alert(result.message);
            location.reload();
        }

        // ... weitere Funktionen (toggleStatus, updateDevice, etc.) ...
    </script>
</head>
<body>
    <h2>Admin Dashboard</h2>
    <a href="{{ url_for('logout') }}">Logout</a>
    <a href="{{ url_for('admin_users') }}">Benutzerverwaltung</a>

    <!-- Formular zum Hinzufügen eines neuen Geräts -->
    <h3>Neues Gerät hinzufügen</h3>
    <input type="text" id="new_inventory_number" placeholder="Inventarnummer">
    <button onclick="addDevice()">Gerät hinzufügen</button>

    <table id="adminTable" border="1">
        <thead>
            <tr>
                <th onclick="sortTable(0)">ID</th>
                <th onclick="sortTable(1)">Inventarnummer</th>
                <th onclick="sortTable(2)">User</th>
                <th onclick="sortTable(3)">Ausgeliehen am</th>
                <th onclick="sortTable(4)">Zurückgegeben am</th>
                <th>Unterschrift</th>
                <th onclick="sortTable(5)">Status</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr>
                <td>{{ device["id"] }}</td>
                <td><input type="text" id="inventory_number_{{ device['id'] }}" value="{{ device['inventory_number'] }}"></td>
                <td><input type="text" id="user_{{ device['id'] }}" value="{{ device['user'] if device['user'] else '' }}"></td>
                <td><input type="text" id="checked_out_at_{{ device['id'] }}" value="{{ device['checked_out_at'] }}"></td>
                <td><input type="text" id="checked_in_at_{{ device['id'] }}" value="{{ device['checked_in_at'] }}"></td>
                <td>
                    {% if device['signature'] %}
                        <img src="{{ device['signature'] }}" alt="Unterschrift" width="100">
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td id="status_{{ device['id'] }}">
                    {% if device['user'] %}
                        <span style="color: red; font-weight: bold;">In Benutzung</span>
                    {% else %}
                        <span style="color: green; font-weight: bold;">Verfügbar</span>
                    {% endif %}
                </td>
                <td>
                    <button onclick="updateDevice({{ device['id'] }})">Speichern</button>
                    <button onclick="toggleStatus({{ device['id'] }})">Status ändern</button>
                    <!-- Neuer Löschen-Button für das Gerät -->
                    <button onclick="deleteDevice({{ device['id'] }})">Löschen</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</body>
</html>